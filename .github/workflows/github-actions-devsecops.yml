name: DevSecOps Pipeline


on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]


permissions:
  contents: read
  security-events: write
  actions: read


env:
  IMAGE_NAME: caga.es
 
jobs:
  secret-scan:
    name: Secret Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout código
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
     
      - name: Ejecutar Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


  dependency-scan:
    name: Dependency Scan (SCA)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout código
        uses: actions/checkout@v4
     
      - name: Ejecutar Trivy - Filesystem Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'


  sast-scan:
    name: SAST Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout código
        uses: actions/checkout@v4
     
      - name: Instalar Semgrep
        run: pip install semgrep
     
      - name: Ejecutar Semgrep
        run: |
          semgrep --config=p/owasp-top-ten --config=p/security-audit --config=p/secrets .




  iac-scan:
    name: IaC Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout código
        uses: actions/checkout@v4
     
      - name: Ejecutar Checkov
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: .
          framework: all
          output_format: cli
         
  build-and-scan:
    name: Build & Container Scan
    runs-on: ubuntu-latest
    needs: [secret-scan, dependency-scan, sast-scan, iac-scan]
    steps:
      - name: Checkout código
        uses: actions/checkout@v4
     
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
     
      - name: Build imagen Docker
        run: |
          docker build -t test .
     
      - name: Escanear imagen con Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'test'
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'
     
      - name: Generar SBOM (Software Bill of Materials)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'test'
          format: 'cyclonedx'
          output: 'sbom.json'
     
      - name: Subir SBOM como artefacto
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: sbom.json
