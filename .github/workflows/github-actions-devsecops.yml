name: DevSecOps Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

permissions:
  contents: read
  security-events: write
  actions: read

env:
  IMAGE_NAME: caga.es
  
jobs:
  # ===========================================================================
  # FASE 1: SECRET SCANNING
  # Herramienta: Gitleaks
  # Riesgo mitigado: Credenciales en c√≥digo fuente
  # ===========================================================================
  secret-scan:
    name: Secret Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Ejecutar Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ===========================================================================
  # FASE 2: SOFTWARE COMPOSITION ANALYSIS (SCA)
  # Herramienta: Trivy
  # Riesgo mitigado: Vulnerabilidades en dependencias de terceros
  # ===========================================================================
  dependency-scan:
    name: Dependency Scan (SCA)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
      
      - name: Ejecutar Trivy - Filesystem Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'  # Cambiado a 0 para no fallar durante pruebas

  # ===========================================================================
  # FASE 3: STATIC APPLICATION SECURITY TESTING (SAST)
  # Herramienta: Semgrep
  # Riesgo mitigado: Vulnerabilidades en c√≥digo propio (SQLi, XSS, etc.)
  # ===========================================================================
  sast-scan:
    name: SAST Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
      
      - name: Instalar Semgrep
        run: pip install semgrep
      
      - name: Ejecutar Semgrep
        run: |
          semgrep --config=p/owasp-top-ten --config=p/security-audit --config=p/secrets . || true

  # ===========================================================================
  # FASE 4: INFRASTRUCTURE AS CODE SECURITY
  # Herramienta: Checkov
  # Riesgo mitigado: Misconfigurations en Terraform, Dockerfiles, K8s
  # ===========================================================================
  iac-scan:
    name: IaC Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
      
      - name: Ejecutar Checkov
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: .
          framework: all
          output_format: cli
          soft_fail: true  # Cambiado a true para no fallar durante pruebas

  # ===========================================================================
  # FASE 5: BUILD & CONTAINER SECURITY
  # Herramienta: Trivy (Container Scan)
  # Riesgo mitigado: Vulnerabilidades en imagen Docker
  # ===========================================================================
  build-and-scan:
    name: Build & Container Scan
    runs-on: ubuntu-latest
    needs: [secret-scan, dependency-scan, sast-scan, iac-scan]
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build imagen Docker
        run: |
          docker build -t test .
      
      - name: Escanear imagen con Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'test'
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'  # Cambiado a 0 para no fallar durante pruebas
      
      - name: Generar SBOM (Software Bill of Materials)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'test'
          format: 'cyclonedx'
          output: 'sbom.json'
      
      - name: Subir SBOM como artefacto
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: sbom.json

  # ===========================================================================
  # RESUMEN DE SEGURIDAD
  # ===========================================================================
  summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [secret-scan, dependency-scan, sast-scan, iac-scan, build-and-scan]
    if: always()
    steps:
      - name: Generar resumen
        run: |
          echo "## üîí DevSecOps Pipeline - Resultados" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Fase | Resultado |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----------|" >> $GITHUB_STEP_SUMMARY
          echo "| üîë Secret Scanning | ${{ needs.secret-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| üì¶ Dependency Scan (SCA) | ${{ needs.dependency-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| üîç SAST Scan | ${{ needs.sast-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| üèóÔ∏è IaC Security | ${{ needs.iac-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| üê≥ Container Scan | ${{ needs.build-and-scan.result }} |" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # FASE 6: DEPLOY A STAGING (COMENTADO)
  # Despliega solo si todos los escaneos pasaron
  # ===========================================================================
  # deploy-staging:
    # name: Deploy Staging
    # runs-on: ubuntu-latest
    # needs: [build-and-scan]
    # environment: staging
    # steps:
      # - name: Checkout c√≥digo
        # uses: actions/checkout@v4
      
      # - name: Deploy a staging
        # run: |

  # ===========================================================================
  # FASE 7: DYNAMIC APPLICATION SECURITY TESTING (DAST) (COMENTADO)
  # Herramienta: OWASP ZAP
  # Riesgo mitigado: Vulnerabilidades en runtime (OWASP Top 10)
  # ===========================================================================
  # dast-scan:
    # name: DAST Scan
    # runs-on: ubuntu-latest
    # needs: [deploy-staging]
    # steps:
      # - name: Checkout c√≥digo
        # uses: actions/checkout@v4
      
      # - name: Ejecutar OWASP ZAP Baseline Scan
        # uses: zaproxy/action-baseline@v0.12.0
        # with:
          # target: 'https://staging.tudominio.com'
          # rules_file_name: '.zap/rules.tsv'
          # cmd_options: '-a'
      
      # - name: Subir reporte ZAP
        # uses: actions/upload-artifact@v4
        # if: always()
        # with:
          # name: zap-report
          # path: report_html.html

  # ===========================================================================
  # FASE 8: DEPLOY A PRODUCCI√ìN (COMENTADO)
  # Solo despu√©s de pasar DAST, con aprobaci√≥n manual
  # ===========================================================================
  # deploy-production:
    # name: Deploy Production
    # runs-on: ubuntu-latest
    # needs: [dast-scan]
    # environment: 
      # name: production
      # url: https://tudominio.com
    # steps:
      # - name: Checkout c√≥digo
        # uses: actions/checkout@v4
      
      # - name: Deploy a producci√≥n
        # run: |
